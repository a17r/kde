From eb25c6e1e15e296929a90611cb6060413536c7f0 Mon Sep 17 00:00:00 2001
From: Arfrever Frehtes Taifersar Arahesis <Arfrever@Apache.Org>
Date: Wed, 30 May 2018 08:13:25 +0200
Subject: [PATCH] Make dependency on KF5NetworkManagerQt optional.

---
 CMakeLists.txt                 |  5 ++++-
 kded/CMakeLists.txt            |  9 ++++++++-
 kded/config-plasma-vault.cmake |  1 +
 kded/service.cpp               | 15 +++++++++++++++
 4 files changed, 28 insertions(+), 2 deletions(-)
 create mode 100644 kded/config-plasma-vault.cmake

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 3011d43..f2c2a68 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -58,8 +58,11 @@ find_package (
    KIO
    Plasma
    WidgetsAddons
-   NetworkManagerQt
    )
+find_package (KF5NetworkManagerQt ${KF5_DEP_VERSION})
+if (KF5NetworkManagerQt_FOUND)
+    set (HAVE_NETWORKMANAGER TRUE)
+endif()
 find_package (KF5SysGuard REQUIRED)
 
 include_directories (
diff --git a/kded/CMakeLists.txt b/kded/CMakeLists.txt
index 666100e..0d138d8 100644
--- a/kded/CMakeLists.txt
+++ b/kded/CMakeLists.txt
@@ -1,3 +1,5 @@
+configure_file (config-plasma-vault.cmake ${CMAKE_CURRENT_BINARY_DIR}/config-plasma-vault.h)
+
 include_directories (
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/engine
@@ -85,8 +87,13 @@ target_link_libraries (
    KF5::SysGuard
    KF5::WidgetsAddons
    KF5::ProcessCore
-   KF5::NetworkManagerQt
    )
+if (HAVE_NETWORKMANAGER)
+    target_link_libraries (
+       kded_plasmavault
+       KF5::NetworkManagerQt
+    )
+endif ()
 
 
 install (
diff --git a/kded/config-plasma-vault.cmake b/kded/config-plasma-vault.cmake
new file mode 100644
index 0000000..35d0003
--- /dev/null
+++ b/kded/config-plasma-vault.cmake
@@ -0,0 +1 @@
+#cmakedefine HAVE_NETWORKMANAGER
diff --git a/kded/service.cpp b/kded/service.cpp
index 33ce52d..be4274e 100644
--- a/kded/service.cpp
+++ b/kded/service.cpp
@@ -37,7 +37,22 @@
 
 #include <functional>
 
+#include <config-plasma-vault.h>
+#ifdef HAVE_NETWORKMANAGER
 #include <NetworkManagerQt/Manager>
+#else
+namespace NetworkManager
+{
+    bool isNetworkingEnabled()
+    {
+        return true;
+    }
+
+    void setNetworkingEnabled(bool enabled)
+    {
+    }
+}
+#endif
 
 K_PLUGIN_FACTORY_WITH_JSON(PlasmaVaultServiceFactory,
                            "plasmavault.json",
-- 
2.17.1

